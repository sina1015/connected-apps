<html>
<head>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="app.css">

    <!-- Facilio Connected Apps SDK-->
    <script type="text/javascript" src="https://static.facilio.com/apps-sdk/latest/facilio_apps_sdk.min.js"></script>

    <!-- import CSS -->
    <link rel="stylesheet" href="https://unpkg.com/element-ui/lib/theme-chalk/index.css">
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    
    
    <!-- VueJS-->
    <script src="https://cdn.jsdelivr.net/npm/vue@2"></script>

    <!-- import JavaScript -->
    <script src="https://unpkg.com/element-ui/lib/index.js"></script>
    <script src="//unpkg.com/element-ui/lib/umd/locale/en.js"></script>

    <script type="text/javascript" src="app.js"></script>
</head>
<body>
    <div id="app">
        <div  class="fc-recent-wo-con">
            <div class="max-w-4xl mx-auto bg-white rounded-l overflow-hidden md:max-w-full">
                <div class="md:flex space-x-4">
                    <div class="p-4">
                       <div class="flex items-center text-gray-600 text-sm">
                        <span class="font-medium">Model:</span>
                        <span class="ml-2 text-gray-800 text-xs">{{ model }}</span>
                    </div>
                    <div class="flex items-center mt-4 text-gray-600 text-sm">
                        <span class="font-medium">Manufacturer:</span>
                        <span class="ml-2 text-gray-800 text-xs">{{ manufacturer }}</span>
                    </div>
                    <div class="flex items-center mt-4 text-gray-600 text-sm">
                        <span class="font-medium">Serial Number:</span>
                        <span class="ml-2 text-gray-800 text-xs">{{ serialNumber }}</span>
                    </div>
                    <div class="flex items-center mt-4 text-gray-600 text-sm">
                        <span class="font-medium">Warranty Name:</span>
                        <span class="ml-2 text-gray-800 text-xs">{{ warrantyName }}</span>
                    </div>
                    <div class="flex items-center mt-4 text-gray-600 text-sm">
                        <span class="font-medium">Warranty Expiry Date:</span>
                        <span class="ml-2 text-gray-800 text-xs">{{ warrentyExpiryDatex }}</span>
                    </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="text/javascript">

        var app = new Vue({
            el: '#app',
            data () {
                return {
                    model: '',
                    manufacturer: '',
                    warrantyName: '',
                    warrentyExpiryDatex: '',
                    serialNumber: '',
                    dataFetched: false,
                    criteriaMap: {},
                    asset: null,
                }
            },
            mounted() {
                console.log("Asset: Page is loading");
                window.facilioApp = FacilioAppSDK.init();
                window.facilioApp.on("form.resource.changed", (resource) => { // space_workorder
                    console.log("asset field changes-->", resource.value.id)
                    this.asset = resource.value.id;
                    this.criteriaMap.asset = resource.value.id;
                    this.fetchWorkorders(this.criteriaMap);
                }); // siteId

                window.facilioApp.on("form.siteId.changed", (siteId) => { // space_workorder
                    window.facilioApp.interface.trigger("getValue", {fieldName: "resource"})
                    .then(data => {
                        console.log("asset field value: ", data.id);
                        this.criteriaMap.asset = data.id;
                        this.fetchWorkorders(this.criteriaMap);
                    });
                });
                
                if (this.criteriaMap.asset == null ) {
                    window.facilioApp.interface.trigger("getValue", {fieldName: "resource"})
                    .then(data => {
                        console.log("field value: ", data.id);
                        this.criteriaMap.asset = data.id;
                        this.fetchWorkorders(this.criteriaMap);
                    });
                }
            },
            methods: {
                async fetchWorkorders(criteriaMap) {
                    console.log("logger: ",criteriaMap)
                    let res
                    let urlParams = {
                        method: 'post',
                        data: {
                            workflowId: 389,
                            paramList: [this.criteriaMap]
                        }
                    }
                    console.log(urlParams)
                    try {
                        const response = await window.facilioApp.request.invokeFacilioAPI('/v2/workflow/runWorkflow', urlParams)
                        
                        if (response.result && response.result.workflow) {
                            res = response.result && response.result.workflow && response.result.workflow.returnValue && response.result.workflow.returnValue
                            console.log("asset function res", res);

                            this.model = res.model || '';
                            this.manufacturer = res.manufacturer || '';
                            this.warrantyName = res.warrentyName || '';
                            this.warrentyExpiryDatex = res.warrentyExpiryDate || '';
                            this.serialNumber = res.serialNumber || '';
                            
                        }
                    } catch(error) {
                        console.error('Error fetching data:', error);
                    }
                }
            },
        })
    </script>
    <style>
    .fc-card-hover {
        -webkit-text-size-adjust: 100%;
        font-family: system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif,BlinkMacSystemFont,"Segoe UI","Helvetica Neue",Arial,"Noto Sans","Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";
        line-height: 1.5;
        box-sizing: border-box;
        border: 0 solid #e2e8f0;
        cursor: pointer;
        padding: 15px 10px 0;
    }
    .fc-recent-wo-con{
        position: relative;
    }
    #app {
        font-family: Roboto, "SF Pro Display", -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica;
    }
    </style>
</body>
</html>
